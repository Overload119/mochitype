---
title: Mochitype - Ruby to TypeScript Type Converter
description: Comprehensive overview of the Mochitype codebase, architecture, and development practices
tags: [ruby, typescript, sorbet, zod, type-conversion]
---

# Mochitype - Ruby to TypeScript Type Converter

## Project Overview

Mochitype is a Ruby gem that automatically converts Sorbet `T::Struct` and `T::Enum` classes into TypeScript Zod schemas, keeping frontend types in sync with backend Ruby code. This enables:
- TypeScript interfaces automatically inferred from Zod schemas
- Runtime type validation with Zod
- Type-safe JSON payload construction using Sorbet

**Status**: Work in Progress (WIP)
**Version**: See `lib/mochitype/version.rb`

## Architecture

### Core Components

1. **Configuration** (`lib/mochitype/configuration.rb`)
   - `watch_path`: Directory containing Ruby type definitions (default: `app/mochitypes/`)
   - `output_path`: Directory for generated TypeScript files (default: `app/javascript/__generated__/mochitypes`)
   - Configuration triggers file watcher in Rails development mode

2. **File Watcher** (`lib/mochitype/file_watcher.rb`)
   - Monitors `watch_path` for Ruby file changes using the `listen` gem
   - On Rails boot: converts all existing files, then watches for changes
   - On add/modify: regenerates corresponding TypeScript file
   - On delete: removes corresponding TypeScript file
   - Performs initial sweep to clean orphaned TS files and backfill missing ones

3. **Type Conversion** (`lib/mochitype/type_converter.rb` + `lib/mochitype/reflection_type_converter.rb`)
   - **TypeConverter**: Public API, determines output paths and orchestrates conversion
   - **ReflectionTypeConverter**: Core conversion logic using Sorbet runtime reflection
   - Uses Prism AST parser to extract main class names
   - Converts Sorbet types to Zod schemas:
     - `String` → `z.string()`
     - `Integer/Float/Numeric` → `z.number()`
     - `T::Array[T]` → `z.array(T)`
     - `T::Enum` → `z.enum([...])`
     - `T::Struct` → `z.object({...})`
     - Unions, booleans, typed hashes, nullable types
   - Hoists inner/nested classes before parent in generated output
   - Generates both schema and type: `<Name>Schema` constant and `T<Name>Schema` type

4. **Data Models**
   - `ConvertibleClass` (`lib/mochitype/convertible_class.rb`): Represents a Ruby class being converted
   - `ConvertibleProperty` (`lib/mochitype/convertible_property.rb`): Represents a property/field with Zod definition

5. **Rails Integration**
   - Entry point: `lib/mochitype.rb` (loads all dependencies)
   - Railtie: `lib/mochitype/railtie.rb` (currently empty placeholder)
   - View helpers available but not yet implemented

### Generated TypeScript Format

```typescript
/**
/* This file is generated by Mochitype. Do not edit it by hand.
/**/

import { z } from 'zod';

export const UserSchema = z.object({
  id: z.number(),
  name: z.string(),
  email: z.string()
});

export type TUserSchema = z.infer<typeof UserSchema>;
```

### File Path Mapping

Output path mirrors input path relative to `watch_path`:
- Input: `app/mochitypes/users/profile.rb`
- Output: `app/javascript/__generated__/mochitypes/users/profile.ts`

## Example App

Located in `examples/example-app/`:
- Standard Rails 7 application
- Demonstrates Mochitype configuration and usage
- Types in `app/mochitypes/mochitypes/`
- Generated TS in `app/assets/javascript/__generated__/mochitypes/`
- See `config/initializers/mochitype.rb` for setup
- Run with: `bin/example-server`

## Development

### Running Tests
```bash
bundle install
bundle exec rspec
```

### Test Structure
- Specs in `spec/mochitype/`
- Test fixtures in `spec/test-data/`
- Generated test output in `spec/test-data/__generated__/`

### Dependencies
- **Runtime**: `rails` (>= 6.0), `listen` (~> 3.8), `sorbet-runtime` (>= 0.5)
- **Development**: `sorbet` (>= 0.5.11094), `rspec`, `rspec-rails`, `rake`
- **Frontend**: Requires `zod` in the TypeScript/JavaScript project

### Ruby Version
- README mentions Ruby 3.3.5+ required for Prism parser
- Gemspec currently allows >= 2.6.0 (needs alignment)

## Code Conventions

- Use `# typed: true` for Sorbet type checking
- Use `# frozen_string_literal: true` for performance
- Explicit Sorbet signatures with `sig` and `extend T::Sig`
- Error handling: log errors, don't silently fail
- Keep code clear and explicit, avoid magic

## Known Limitations & TODOs

1. **Gemspec metadata**: Summary/description/homepage are outdated placeholders
2. **Ruby version mismatch**: Gemspec allows Ruby 2.6+, but Prism needs 3.3.5+
3. **Type coverage**: Missing support for Date, Time, BigDecimal, branded types
4. **No deduplication**: Each TS file contains all referenced types inline
5. **TypedHash**: Basic support, could be enhanced for key/value typing
6. **View helpers**: Placeholder code in `lib/mochitype/view.rb` not yet functional
7. **Railtie**: Empty, could be used for automatic Rails integration

## Directory Structure

```
lib/
├── mochitype.rb                      # Main entry point
├── mochitype/
│   ├── configuration.rb              # Config management
│   ├── file_watcher.rb              # File change detection
│   ├── type_converter.rb            # Public conversion API
│   ├── reflection_type_converter.rb # Core conversion logic
│   ├── convertible_class.rb         # Class data model
│   ├── convertible_property.rb      # Property data model
│   ├── ruby_type_utils.rb           # Ruby type utilities
│   ├── typescript_utils.rb          # TS generation utilities
│   ├── view.rb                      # View helpers (WIP)
│   ├── railtie.rb                   # Rails integration
│   └── version.rb                   # Gem version

examples/example-app/                 # Example Rails app
spec/                                 # RSpec tests
bin/                                  # Executable scripts
```

## Contributing

When making changes:
- Ensure backward compatibility for public APIs
- Add tests for new type conversions
- Update README if changing configuration or behavior
- Keep Sorbet signatures up to date
- Test with the example app end-to-end
- Consider edge cases: nested types, circular references, nil handling

## Useful Commands

```bash
# Run specs
bundle exec rspec

# Try example app
bin/example-server

# Type check with Sorbet
bundle exec srb tc

# Build gem
gem build mochitype.gemspec
```
