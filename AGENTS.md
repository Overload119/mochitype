## Purpose

Mochitype keeps frontend TypeScript types in sync with backend Ruby payloads by converting Sorbet `T::Struct`/`T::Enum` classes into Zod schemas and inferred TS types. It also provides a development file watcher that regenerates TS on change.

- **Status**: WIP (see `README.md`). Version in code: `lib/mochitype/version.rb`.
- **Primary entrypoint**: `lib/mochitype.rb` (loads configuration, converters, watcher, and Railtie).

## How it works

- **Configuration** (`lib/mochitype/configuration.rb`)
  - `watch_path`: where Ruby types live (default `app/mochitypes/`).
  - `output_path`: where generated TS goes (default `app/javascript/__generated__/mochitypes`).
  - `Mochitype.configure { |c| ... }` also starts the file watcher in development.
- **Watcher** (`lib/mochitype/file_watcher.rb`)
  - On Rails development boot, converts all `*.rb` under `watch_path` once, then listens for changes.
  - On add/modify: regenerates TS. On delete: removes corresponding TS. Also prunes orphaned TS and backfills missing TS in an initial sweep.
- **Conversion**
  - `Mochitype::TypeConverter` (`lib/mochitype/type_converter.rb`) delegates logic to `ReflectionTypeConverter` and writes files to `output_path` mirroring the relative structure under `watch_path`.
  - `ReflectionTypeConverter` (`lib/mochitype/reflection_type_converter.rb`) inspects Sorbet types and emits Zod:
    - Maps `String` → `z.string()`, `Integer|Float|Numeric` → `z.number()`.
    - Emits `z.enum([...])` for `T::Enum` and `z.object({...})` for `T::Struct`.
    - Handles arrays (`T::Array[...]`), unions (incl. boolean), and nested structs by hoisting inner classes before the parent.
  - Generated files import `zod` and export:
    - `export const <ClassName>Schema = z.object({...})` (or `<ClassName>Enum` for enums)
    - `export type T<ClassName>Schema = z.infer<typeof <ClassName>Schema>`

## Example app

- Location: `examples/example-app`
- Initializer: `examples/example-app/config/initializers/mochitype.rb`
  - Sets `watch_path = 'app/mochitypes/mochitypes'`
  - Sets `output_path = 'app/assets/javascript/__generated__/mochitypes'`
- Try it:
  1. `cd examples/example-app && bundle install`
  2. `bin/rails s` (development). Watcher logs will print converted/removed files.
  3. Edit files under `app/mochitypes/mochitypes/**.rb` and observe TS updates under `app/assets/javascript/__generated__/mochitypes`.

## Requirements

- Ruby: README mentions Prism requires Ruby 3.3.5+; update gemspec when aligning.
- Rails: dependency `>= 6.0` (see `mochitype.gemspec`).
- Runtime deps: `listen`, `sorbet-runtime`, `zod` in the frontend (example app vendors it at `examples/example-app/vendor/javascript/zod.js`).

## Developing the gem

- Install: `bundle install`
- Tests: `bundle exec rspec`
- Code style: files generally use `# typed: true` and `# frozen_string_literal: true`.
- Sorbet: keep public APIs typed; avoid catching without handling; keep code clear and explicit.

## Conventions and outputs

- File mapping: output path mirrors input path relative to `watch_path` (see `TypeConverter.determine_output_path`). Ensure `watch_path` is stable; consider including a trailing `/` to avoid surprising regex matches in replacements.
- Naming:
  - Structs → `<ClassName>Schema` constant; Enums → `<ClassName>Enum`.
  - Type alias always `T<ExportName>` (e.g., `TUserProfileSchema`).
- Header: generated TS starts with a “generated by Mochitype” comment and `import { z } from 'zod'`.

## Known gaps/inconsistencies (good first issues)

- `mochitype.gemspec` summary/description/homepage are placeholders and describe a generic view helper; align with current purpose and repository URLs.
- `lib/mochitype/railtie.rb` is empty; consider wiring helpers or initializers as needed.
- Ruby version: README implies Ruby 3.3.5+ due to Prism, while gemspec allows `>= 2.6.0`. Align and document clearly.
- `T::Types::TypedHash` handling in `ReflectionTypeConverter#write_prop` currently uses `data[:type].first/last` directly; expand to produce Zod for key/value types.
- `Mochitype::View` and `Mochitype::ViewHelper#mochitype_render` are placeholders; decide integration or remove until ready.

## Extending conversion

- Add more Sorbet→Zod mappings (e.g., `Time`, `Date`, `BigDecimal`, maps/records with proper key/value typing, optional vs nullable, branded types).
- Support custom type adapters and reference reuse to dedupe identical nested types across files.
- Introduce an AST-based converter (if needed for non-loaded constants) and reconcile with reflection-based approach.

## Release checklist

- Update `VERSION` in `lib/mochitype/version.rb`.
- Ensure gemspec metadata, required Ruby version, and README are consistent.
- Run tests and try the example app end-to-end.
- Tag and publish.

## Quick reference (files)

- Config: `lib/mochitype/configuration.rb`
- Watcher: `lib/mochitype/file_watcher.rb`
- Converter (public): `lib/mochitype/type_converter.rb`
- Converter (logic): `lib/mochitype/reflection_type_converter.rb`
- Data containers: `lib/mochitype/convertible_class.rb`, `lib/mochitype/convertible_property.rb`
- Entry: `lib/mochitype.rb`
- Version: `lib/mochitype/version.rb`
- Example initializer: `examples/example-app/config/initializers/mochitype.rb`
